<!DOCTYPE html>
<html lang="en">
<head>
<script>
  (async () => {
    const stored = Object.keys(localStorage).find(k => k.startsWith('sb-') && k.endsWith('-auth-token'));
    if (!stored) window.location.replace('../login/');
  })();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Ledger â€” Dashboard</title>
<link rel="icon" type="image/x-icon" href="/ledger/favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<script src="config.js"></script>
<script src="api.js"></script>
<script src="theme.js"></script>
<style>
  :root {
    --bg: #0a0a0f; --surface: #111118; --border: #1e1e2e;
    --accent: #c8f560; --accent-text: #0a0a0f; --accent2: #7c6af7;
    --text: #e8e8f0; --muted: #5a5a7a; --danger: #ff5f6d; --success: #4ade80;
    --grid-line: rgba(200,245,96,0.025); --hover-border: #2e2e4e;
    --overlay: rgba(0,0,0,0.7);
  }
  [data-theme="light"] {
    --bg: #f5f5f0; --surface: #ffffff; --border: #e0e0d8;
    --accent: #5a8a00; --accent-text: #ffffff; --accent2: #5b4fcf;
    --text: #1a1a24; --muted: #8a8a9a; --danger: #d93025; --success: #1e7e34;
    --grid-line: rgba(90,138,0,0.05); --hover-border: #c8c8c0;
    --overlay: rgba(0,0,0,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; min-height: 100vh; transition: background 0.3s, color 0.3s; }

  .grid-bg {
    position: fixed; inset: 0;
    background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none;
  }

  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.9); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border); padding: 0 24px; height: 60px;
    display: flex; align-items: center; justify-content: space-between;
    transition: background 0.3s, border-color 0.3s;
  }
  [data-theme="light"] nav { background: rgba(245,245,240,0.92); }

  .nav-brand { font-family: 'Roboto Slab', serif; font-size: 1.4rem; color: var(--accent); text-decoration: none; }
  .nav-right { display: flex; align-items: center; gap: 8px; }
  .nav-user { font-size: 0.75rem; color: var(--muted); }
  .nav-links { display: flex; gap: 4px; align-items: center; }

  .nav-link {
    padding: 7px 14px; border-radius: 6px; font-family: 'Roboto', sans-serif;
    font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase;
    cursor: pointer; border: none; background: none; color: var(--muted);
    transition: all 0.2s; text-decoration: none; display: inline-block;
  }
  .nav-link:hover, .nav-link.active { color: var(--text); background: var(--border); }
  .nav-link.logout { color: var(--danger); }
  .nav-link.logout:hover { background: rgba(217,48,37,0.1); }

  .icon-btn {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; width: 34px; height: 34px; font-size: 0.95rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; color: var(--text); flex-shrink: 0;
  }
  .icon-btn:hover { border-color: var(--accent); }

  main { max-width: 760px; margin: 0 auto; padding: 40px 20px 80px; position: relative; z-index: 1; }

  .input-section { margin-bottom: 40px; }
  .input-label { font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }
  .input-wrapper { position: relative; }

  .main-input {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 60px 20px 20px; color: var(--text);
    font-family: 'Roboto', sans-serif; font-size: 1.1rem;
    outline: none; transition: all 0.3s; caret-color: var(--accent);
  }
  .main-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(200,245,96,0.08); }
  .main-input::placeholder { color: var(--muted); font-size: 0.9rem; }

  .submit-btn {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    width: 36px; height: 36px; background: var(--accent); border: none;
    border-radius: 8px; cursor: pointer; display: flex; align-items: center;
    justify-content: center; transition: all 0.2s; color: var(--accent-text); font-size: 1rem;
  }
  .submit-btn:hover { transform: translateY(-50%) scale(1.05); }

  .input-hint { font-size: 0.7rem; color: var(--muted); margin-top: 8px; }
  .input-hint span { color: var(--accent); }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; right: 24px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 10px; padding: 12px 18px;
    font-size: 0.8rem; z-index: 2000; transform: translateY(80px); opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); max-width: 300px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-color: rgba(74,222,128,0.4); color: var(--success); }
  .toast.error { border-color: rgba(255,95,109,0.4); color: var(--danger); }

  /* Stats */
  .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 32px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; transition: background 0.3s, border-color 0.3s; }
  .stat-label { font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .stat-value { font-family: 'Roboto Slab', serif; font-size: 1.5rem; }
  .stat-value.expense { color: var(--danger); }
  .stat-value.income  { color: var(--success); }

  .section-title { font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 16px; }

  /* Transaction list */
  .tx-list { display: flex; flex-direction: column; gap: 8px; }

  .tx-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px;
    display: flex; align-items: center; gap: 14px;
    animation: slideIn 0.3s ease forwards;
    transition: border-color 0.2s, background 0.3s;
  }
  .tx-item:hover { border-color: var(--hover-border); }

  @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

  .tx-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .tx-info { flex: 1; min-width: 0; }
  .tx-top { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
  .tx-category { font-size: 0.8rem; font-weight: 500; }
  .tx-notes { font-size: 0.75rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
  .tx-date { font-size: 0.65rem; color: var(--muted); margin-top: 2px; }

  .tx-amount { font-family: 'Roboto Slab', serif; font-size: 1.1rem; flex-shrink: 0; }
  .tx-amount.expense { color: var(--danger); }
  .tx-amount.income  { color: var(--success); }

  .tx-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; flex-shrink: 0; }
  .tx-item:hover .tx-actions { opacity: 1; }

  .tx-btn {
    background: none; border: none; cursor: pointer;
    font-size: 0.75rem; padding: 5px 7px; border-radius: 5px;
    color: var(--muted); transition: all 0.15s;
  }
  .tx-btn:hover { background: var(--border); }
  .tx-btn.del:hover { color: var(--danger); }
  .tx-btn.edit:hover { color: var(--accent); }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .big { font-size: 3rem; margin-bottom: 12px; }
  .empty-state p { font-size: 0.8rem; }

  .load-more {
    display: block; width: 100%; margin-top: 12px; padding: 10px;
    background: none; border: 1px dashed var(--border); border-radius: 8px;
    color: var(--muted); font-family: 'Roboto', sans-serif;
    font-size: 0.75rem; cursor: pointer; transition: all 0.2s;
  }
  .load-more:hover { border-color: var(--accent); color: var(--accent); }

  /* Period filter */
  .list-header {
    display: flex; align-items: center;
    justify-content: space-between; margin-bottom: 16px; gap: 12px; flex-wrap: wrap;
  }

  .period-tabs {
    display: flex; gap: 4px; flex-wrap: wrap;
  }

  .period-tab {
    padding: 5px 10px; border-radius: 6px; border: 1px solid var(--border);
    background: none; font-family: 'Roboto', sans-serif; font-size: 0.7rem;
    letter-spacing: 0.04em; color: var(--muted); cursor: pointer;
    transition: all 0.15s; white-space: nowrap;
  }
  .period-tab:hover { color: var(--text); border-color: var(--hover-border); }
  .period-tab.active { background: var(--accent); color: var(--accent-text); border-color: var(--accent); }

  /* Custom date range row */
  .date-range {
    display: none; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;
  }
  .date-range.show { display: flex; }
  .date-range input[type="date"] {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 7px 10px; color: var(--text); font-family: 'Roboto', sans-serif;
    font-size: 14px; outline: none; transition: border-color 0.2s;
    color-scheme: dark;
  }
  [data-theme="light"] .date-range input[type="date"] { color-scheme: light; }
  .date-range input[type="date"]:focus { border-color: var(--accent); }
  .date-range-sep { color: var(--muted); font-size: 0.75rem; }
  .date-range-apply {
    padding: 7px 14px; background: var(--accent); color: var(--accent-text);
    border: none; border-radius: 8px; font-family: 'Roboto', sans-serif;
    font-size: 0.75rem; cursor: pointer; transition: opacity 0.2s;
  }
  .date-range-apply:hover { opacity: 0.85; }

  /* Import progress */
  .import-bar {
    position: fixed; bottom: 80px; right: 24px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 16px; font-size: 0.75rem;
    z-index: 1000; min-width: 200px; display: none;
  }
  .import-bar.show { display: block; }
  .import-bar-label { color: var(--muted); margin-bottom: 6px; }
  .import-bar-track {
    height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;
  }
  .import-bar-fill {
    height: 100%; background: var(--accent); border-radius: 2px;
    transition: width 0.2s; width: 0%;
  }

  .tx-item.pending { opacity: 0.55; }
  .tx-item.pending .tx-dot { animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* â”€â”€ Modal base â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; background: var(--overlay);
    z-index: 500; display: flex; align-items: center; justify-content: center;
    padding: 20px; opacity: 0; pointer-events: none;
    transition: opacity 0.2s;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px; width: 100%; max-width: 420px;
    transform: translateY(16px); transition: transform 0.25s cubic-bezier(0.34,1.4,0.64,1);
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-title {
    font-family: 'Roboto Slab', serif; font-size: 1.3rem;
    margin-bottom: 20px; color: var(--text);
  }

  .field { margin-bottom: 14px; }
  .field label { display: block; font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; }

  .field input, .field select {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 12px; color: var(--text);
    font-family: 'Roboto', sans-serif; font-size: 16px;
    outline: none; transition: border-color 0.2s; appearance: none;
  }
  .field input:focus, .field select:focus { border-color: var(--accent); }

  .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

  .modal-btn {
    flex: 1; padding: 11px; border-radius: 8px; border: none;
    font-family: 'Roboto', sans-serif; font-size: 0.8rem;
    letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer;
    transition: all 0.2s; font-weight: 500;
  }
  .modal-btn.primary { background: var(--accent); color: var(--accent-text); }
  .modal-btn.primary:hover { opacity: 0.9; }
  .modal-btn.secondary { background: var(--border); color: var(--muted); }
  .modal-btn.secondary:hover { color: var(--text); }

  /* Type toggle inside modal */
  .type-toggle { display: flex; gap: 6px; }
  .type-opt {
    flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);
    background: none; font-family: 'Roboto', sans-serif; font-size: 0.75rem;
    cursor: pointer; color: var(--muted); transition: all 0.2s; text-align: center;
  }
  .type-opt.active.expense { background: rgba(255,95,109,0.15); border-color: var(--danger); color: var(--danger); }
  .type-opt.active.income  { background: rgba(74,222,128,0.15);  border-color: var(--success); color: var(--success); }

  @media (max-width: 600px) {
    nav { padding: 0 16px; }
    .nav-user { display: none; }
    .stats-grid { gap: 8px; }
    .stat-value { font-size: 1.2rem; }
    .stat-card { padding: 12px; }
    .main-input { font-size: 16px; }
    .tx-actions { opacity: 1; }
  }
  @media (max-width: 400px) { .stats-grid { grid-template-columns: 1fr; } }

  /* Prevent iOS Safari auto-zoom on any input/select focus */
  @media (max-width: 768px) {
    input, select, textarea { font-size: 16px !important; }
    .modal { margin: 0 8px; }
    .modal-actions { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="grid-bg"></div>

<nav>
  <a class="nav-brand" href="../app/">Ledger</a>
  <div class="nav-right">
    <span class="nav-user" id="nav-user"></span>
    <div class="nav-links">
      <a href="../app/" class="nav-link active">Home</a>
      <a href="../analytics/" class="nav-link">Analytics</a>
      <input type="file" id="file-upload" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleImport(this)">
      <button class="icon-btn" onclick="document.getElementById('file-upload').click()" title="Import XLSX">â‡ª</button>
      <button class="icon-btn" onclick="exportData()" title="Export XLSX">â‡©</button>
      <button class="icon-btn" onclick="openSettings()" title="Settings">âš™</button>
      <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle theme">â˜€</button>
      <button class="nav-link logout" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<main>
  <div class="input-section">
    <div class="input-label">New Transaction</div>
    <div class="input-wrapper">
      <input class="main-input" id="tx-input" type="text"
        placeholder="50 Food Lunch at the cafe..."
        autocomplete="off" autofocus>
      <button class="submit-btn" onclick="addTransaction()" title="Add (Enter)">â†µ</button>
    </div>
    <div class="input-hint">
      Format: <span>&lt;Amount&gt; &lt;Category&gt; &lt;Notes&gt;</span> â€”
      Use <span>-50</span> for income Â· Press <span>Enter</span> to save
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Total Spent</div><div class="stat-value expense" id="stat-expense">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Total Income</div><div class="stat-value income" id="stat-income">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Transactions</div><div class="stat-value" id="stat-count">â€”</div></div>
  </div>

  <div class="list-header">
    <div class="section-title">Recent Transactions</div>
    <div class="period-tabs">
      <button class="period-tab active" onclick="setPeriod('recent', this)">Recent</button>
      <button class="period-tab" onclick="setPeriod('week', this)">This Week</button>
      <button class="period-tab" onclick="setPeriod('month', this)">This Month</button>
      <button class="period-tab" onclick="setPeriod('year', this)">This Year</button>
      <button class="period-tab" onclick="setPeriod('custom', this)">Custom</button>
    </div>
  </div>
  <div class="date-range" id="date-range-row">
    <input type="date" id="range-from">
    <span class="date-range-sep">â†’</span>
    <input type="date" id="range-to">
    <button class="date-range-apply" onclick="applyCustomRange()">Apply</button>
  </div>
  <div class="tx-list" id="tx-list"><div class="empty-state"><p>Loading...</p></div></div>
  <button class="load-more" id="load-more-btn" onclick="loadMore()" style="display:none">Load more</button>
</main>

<div class="toast" id="toast"></div>
<div class="import-bar" id="import-bar">
  <div class="import-bar-label" id="import-bar-label">Importing...</div>
  <div class="import-bar-track"><div class="import-bar-fill" id="import-bar-fill"></div></div>
</div>

<!-- â”€â”€ Edit Transaction Modal â”€â”€ -->
<div class="modal-overlay" id="edit-overlay" onclick="closeEdit(event)">
  <div class="modal">
    <div class="modal-title">Edit Transaction</div>

    <div class="field">
      <label>Type</label>
      <div class="type-toggle">
        <button class="type-opt active expense" id="edit-type-expense" onclick="setEditType('expense')">Expense</button>
        <button class="type-opt income" id="edit-type-income" onclick="setEditType('income')">Income</button>
      </div>
    </div>

    <div class="field">
      <label>Amount</label>
      <input type="number" id="edit-amount" min="0" step="0.01" placeholder="0.00">
    </div>

    <div class="field">
      <label>Category</label>
      <input type="text" id="edit-category" placeholder="Food">
    </div>

    <div class="field">
      <label>Notes</label>
      <input type="text" id="edit-notes" placeholder="Optional notes">
    </div>

    <div class="field">
      <label>Date</label>
      <input type="datetime-local" id="edit-date">
    </div>

    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeEdit()">Cancel</button>
      <button class="modal-btn primary" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Settings Modal â”€â”€ -->
<div class="modal-overlay" id="settings-overlay" onclick="closeSettings(event)">
  <div class="modal">
    <div class="modal-title">Settings</div>

    <div class="field">
      <label>Currency</label>
      <select id="settings-currency">
        <option value="USD">USD â€” US Dollar ($)</option>
        <option value="EUR">EUR â€” Euro (â‚¬)</option>
        <option value="GBP">GBP â€” British Pound (Â£)</option>
        <option value="JPY">JPY â€” Japanese Yen (Â¥)</option>
        <option value="INR">INR â€” Indian Rupee (â‚¹)</option>
        <option value="CAD">CAD â€” Canadian Dollar (CA$)</option>
        <option value="AUD">AUD â€” Australian Dollar (A$)</option>
        <option value="CHF">CHF â€” Swiss Franc (CHF)</option>
        <option value="CNY">CNY â€” Chinese Yuan (Â¥)</option>
        <option value="BRL">BRL â€” Brazilian Real (R$)</option>
        <option value="MXN">MXN â€” Mexican Peso (MX$)</option>
        <option value="SGD">SGD â€” Singapore Dollar (S$)</option>
        <option value="AED">AED â€” UAE Dirham (AED)</option>
        <option value="KRW">KRW â€” South Korean Won (â‚©)</option>
        <option value="SEK">SEK â€” Swedish Krona (kr)</option>
        <option value="NOK">NOK â€” Norwegian Krone (kr)</option>
        <option value="NZD">NZD â€” New Zealand Dollar (NZ$)</option>
        <option value="ZAR">ZAR â€” South African Rand (R)</option>
      </select>
    </div>

    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeSettings()">Cancel</button>
      <button class="modal-btn primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="delete-overlay" onclick="closeModal()">
  <div class="modal">
    <div class="modal-title">Are you sure you want to delete?</div>
    <div class="modal-actions">
    <button class="modal-btn secondary" onclick="closeModal()">No</button>
    <button class="modal-btn primary" onclick="confirmDelete()">Yes</button>
  </div>
  </div>
  
</div>

<script>

const LIMIT = 20;
let offset = 0, transactions = [], currentUser = null;
let activePeriod = 'recent';
let customFrom = null, customTo = null;
let userCurrency = 'USD';
let editingId = null, editingType = 'expense';

const COLORS = ['#c8f560','#7c6af7','#ff5f6d','#4ade80','#fb923c','#38bdf8','#e879f9','#fbbf24','#34d399','#f87171'];
let colorMap = {}, colorIdx = 0;
function catColor(cat) {
  if (!colorMap[cat]) colorMap[cat] = COLORS[colorIdx++ % COLORS.length];
  return colorMap[cat];
}

function fmt(n) {
  return new Intl.NumberFormat(undefined, { style: 'currency', currency: userCurrency, maximumFractionDigits: userCurrency === 'JPY' || userCurrency === 'KRW' ? 0 : 2 }).format(n || 0);
}

function timeAgo(dateStr) {
  const diff = (Date.now() - new Date(dateStr)) / 1000;
  if (diff < 60) return 'just now';
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  return new Date(dateStr).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function parseInput(raw) {
  const m = raw.trim().match(/^(-?\d+(?:\.\d+)?)\s+(\S+)\s*(.*)?$/);
  if (!m) throw new Error('Format: <Amount> <Category> <Notes>');
  const amount = parseFloat(m[1]);
  return { amount: Math.abs(amount), type: amount < 0 ? 'income' : 'expense', category: m[2], notes: m[3]?.trim() || '' };
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  if (!api.auth.isLoggedIn()) return window.location.replace('../login/');
  const accountId = api.auth.getAccountId();
  document.getElementById('nav-user').textContent = accountId;
  document.getElementById('nav-user').title = 'Click to copy Account ID';
  document.getElementById('nav-user').style.cursor = 'pointer';
  document.getElementById('nav-user').onclick = () => {
    navigator.clipboard.writeText(accountId).then(() => {
      document.getElementById('nav-user').textContent = 'Copied!';
      setTimeout(() => document.getElementById('nav-user').textContent = accountId, 2000);
    });
  };
  await loadSettings();
  await Promise.all([loadTransactions(true), loadStats()]);
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSettings() {
  try {
    const data = await api.settings.get();
    if (data?.currency) userCurrency = data.currency;
  } catch {}
}

function openSettings() {
  document.getElementById('settings-currency').value = userCurrency;
  document.getElementById('settings-overlay').classList.add('open');
}

function closeSettings(e) {
  if (e && e.target !== document.getElementById('settings-overlay')) return;
  document.getElementById('settings-overlay').classList.remove('open');
}

async function saveSettings() {
  const currency = document.getElementById('settings-currency').value;
  const prev = userCurrency;

  // Optimistic: apply immediately
  userCurrency = currency;
  document.getElementById('settings-overlay').classList.remove('open');
  renderTransactions();
  updateStatsFrom(transactions);
  showToast('Settings saved', 'success');

  // Sync in background
  try {
    await api.settings.update({ currency });
  } catch {
    userCurrency = prev;
    renderTransactions();
    updateStatsFrom(transactions);
    showToast('Failed to save settings', 'error');
  }
}

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPeriodRange() {
  const now = new Date();
  if (activePeriod === 'week') {
    const from = new Date(now); from.setDate(now.getDate() - 7); from.setHours(0,0,0,0);
    return { from: from.toISOString(), to: null };
  }
  if (activePeriod === 'month') {
    const from = new Date(now.getFullYear(), now.getMonth(), 1);
    return { from: from.toISOString(), to: null };
  }
  if (activePeriod === 'year') {
    const from = new Date(now.getFullYear(), 0, 1);
    return { from: from.toISOString(), to: null };
  }
  if (activePeriod === 'custom' && customFrom) {
    const to = customTo ? new Date(customTo) : null; if (to) to.setHours(23,59,59,999);
    return { from: new Date(customFrom).toISOString(), to: to ? to.toISOString() : null };
  }
  return { from: null, to: null }; // recent â€” no filter
}

async function loadTransactions(reset = false) {
  if (reset) { offset = 0; transactions = []; }

  const limit = activePeriod === 'recent' ? 5 : LIMIT;
  const { from, to } = getPeriodRange();
  let data;
  try {
    data = await api.transactions.list({
      limit,
      offset: activePeriod !== 'recent' ? offset : undefined,
      from: from || undefined,
      to: to || undefined,
    });
  } catch {
    document.getElementById('tx-list').innerHTML = `<div class="empty-state"><p>Error loading transactions.</p></div>`;
    return;
  }
  transactions = reset ? data : [...transactions, ...data];
  if (activePeriod !== 'recent') offset += data.length;
  document.getElementById('load-more-btn').style.display =
    (activePeriod !== 'recent' && data.length === limit) ? 'block' : 'none';
  renderTransactions();
}

function setPeriod(period, btn) {
  activePeriod = period;
  // Toggle active tab
  document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  // Show/hide custom date range row
  document.getElementById('date-range-row').classList.toggle('show', period === 'custom');
  if (period !== 'custom') loadTransactions(true);
}

function applyCustomRange() {
  customFrom = document.getElementById('range-from').value;
  customTo   = document.getElementById('range-to').value;
  if (!customFrom) return showToast('Please select a start date', 'error');
  loadTransactions(true);
}

function renderTransactions() {
  const list = document.getElementById('tx-list');
  if (!transactions.length) {
    list.innerHTML = `<div class="empty-state"><div class="big">ðŸ’¸</div><p>No transactions yet. Add one above!</p></div>`;
    return;
  }
  list.innerHTML = transactions.map(tx => `
    <div class="tx-item${tx._pending ? ' pending' : ''}" id="tx-${tx.id}">
      <div class="tx-dot" style="background:${catColor(tx.category)}"></div>
      <div class="tx-info">
        <div class="tx-top">
          <span class="tx-category">${esc(tx.category)}</span>
          ${tx.notes ? `<span class="tx-notes">${esc(tx.notes)}</span>` : ''}
        </div>
        <div class="tx-date">${timeAgo(tx.created_at)}</div>
      </div>
      <div class="tx-amount ${tx.type}">${tx.type === 'expense' ? '-' : '+'}${fmt(tx.amount)}</div>
      <div class="tx-actions">
        <button class="tx-btn edit" onclick="openEdit('${tx.id}')" title="Edit">âœŽ</button>
        <button class="tx-btn del"  onclick="deleteTx('${tx.id}')" title="Delete">âœ•</button>
      </div>
    </div>
  `).join('');
}

// Compute stats from local array â€” no network call needed
function updateStatsFrom(txns) {
  const expenses = txns.filter(t => t.type === 'expense').reduce((s, t) => s + parseFloat(t.amount), 0);
  const income   = txns.filter(t => t.type === 'income').reduce((s, t) => s + parseFloat(t.amount), 0);
  document.getElementById('stat-expense').textContent = fmt(expenses);
  document.getElementById('stat-income').textContent  = fmt(income);
  document.getElementById('stat-count').textContent   = txns.length;
}

// Full reload from DB (used on init and load-more)
async function loadStats() {
  try {
    const rows = await api.transactions.stats();
    // rows is [{type, total, count}, ...]
    let expenses = 0, income = 0, count = 0;
    rows.forEach(r => {
      if (r.type === 'expense') { expenses = r.total; count += r.count; }
      if (r.type === 'income')  { income  = r.total; count += r.count; }
    });
    document.getElementById('stat-expense').textContent = fmt(expenses);
    document.getElementById('stat-income').textContent  = fmt(income);
    document.getElementById('stat-count').textContent   = count;
  } catch {}
}

// â”€â”€ Add transaction (optimistic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addTransaction() {
  const input = document.getElementById('tx-input');
  const val = input.value.trim();
  if (!val) return;
  let parsed;
  try { parsed = parseInput(val); } catch (e) { return showToast(e.message, 'error'); }

  // Optimistic: clear input & show instantly with a temp id
  input.value = '';
  input.focus();
  const tempId = 'temp-' + Date.now();
  const optimistic = { id: tempId, created_at: new Date().toISOString(), ...parsed, _pending: true };
  transactions.unshift(optimistic);
  if (transactions.length > LIMIT) transactions.pop();
  renderTransactions();
  updateStatsFrom(transactions);

  // Sync in background
  let data;
  try {
    data = await api.transactions.create(parsed);
  } catch {
    transactions = transactions.filter(t => t.id !== tempId);
    renderTransactions();
    updateStatsFrom(transactions);
    return showToast('Failed to save â€” rolled back', 'error');
  }

  const idx = transactions.findIndex(t => t.id === tempId);
  if (idx !== -1) transactions[idx] = data;
  renderTransactions();
  showToast(`Added: ${data.category} ${fmt(data.amount)}`, 'success');
}

// â”€â”€ Edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEdit(id) {
  const tx = transactions.find(t => t.id == id);
  if (!tx) return;
  editingId = id;

  setEditType(tx.type);
  document.getElementById('edit-amount').value   = tx.amount;
  document.getElementById('edit-category').value = tx.category;
  document.getElementById('edit-notes').value    = tx.notes || '';

  // Format date for datetime-local input (needs local ISO without timezone)
  const d = new Date(tx.created_at);
  const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
  document.getElementById('edit-date').value = local;

  document.getElementById('edit-overlay').classList.add('open');
}

function setEditType(type) {
  editingType = type;
  document.getElementById('edit-type-expense').className = `type-opt${type === 'expense' ? ' active expense' : ''}`;
  document.getElementById('edit-type-income').className  = `type-opt${type === 'income'  ? ' active income'  : ''}`;
}

function closeEdit(e) {
  if (e && e.target !== document.getElementById('edit-overlay')) return;
  document.getElementById('edit-overlay').classList.remove('open');
  editingId = null;
}

async function saveEdit() {
  const amount   = parseFloat(document.getElementById('edit-amount').value);
  const category = document.getElementById('edit-category').value.trim();
  const notes    = document.getElementById('edit-notes').value.trim();
  const dateVal  = document.getElementById('edit-date').value;

  if (!amount || !category || !dateVal) return showToast('Please fill all required fields', 'error');

  const created_at = new Date(dateVal).toISOString();
  const updates = { amount, type: editingType, category, notes, created_at };

  // Optimistic: close modal & update UI immediately
  const savedId = editingId;
  const idx = transactions.findIndex(t => t.id == savedId);
  const original = idx !== -1 ? { ...transactions[idx] } : null;
  if (idx !== -1) transactions[idx] = { ...transactions[idx], ...updates };
  renderTransactions();
  updateStatsFrom(transactions);
  document.getElementById('edit-overlay').classList.remove('open');
  editingId = null;
  showToast('Transaction updated', 'success');

  // Sync in background
  try {
    await api.transactions.update(savedId, updates);
  } catch {
    if (idx !== -1 && original) transactions[idx] = original;
    renderTransactions();
    updateStatsFrom(transactions);
    showToast('Update failed â€” rolled back', 'error');
  }
}

// â”€â”€ Delete (optimistic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let delId;
async function deleteTx(id) {
  delId = id;
  const deleteOverlay = document.getElementById('delete-overlay');
  deleteOverlay.classList.add('open');
}

async function confirmDelete(){
  // Optimistic: remove from UI instantly, keep snapshot for rollback
  const snapshot = [...transactions];
    transactions = transactions.filter(t => t.id != delId);
  renderTransactions();
  updateStatsFrom(transactions);
  showToast('Deleted', 'success');

  // Sync in background
  try {
    await api.transactions.remove(id);
  } catch {
    transactions = snapshot;
    renderTransactions();
    updateStatsFrom(transactions);
    showToast('Delete failed â€” rolled back', 'error');
  }
    delId = undefined;
    const deleteOverlay = document.getElementById('delete-overlay');
    deleteOverlay.classList.remove('open');
}

function closeModal() {
  const deleteOverlay = document.getElementById('delete-overlay');
  deleteOverlay.classList.remove('open');
}

function loadMore() { loadTransactions(false); }

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.className = 'toast', 3000);
}

async function logout() {
  api.auth.logout();
}

// â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleImport(input) {
  const file = input.files[0];
  if (!file) return;
  input.value = ''; // reset so same file can be re-imported

  const reader = new FileReader();
  reader.onload = async (e) => {
    let rows;
    try {
      const workbook = XLSX.read(e.target.result, { type: 'binary' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(sheet);
    } catch (err) {
      return showToast('Could not read file', 'error');
    }

    if (!rows.length) return showToast('File is empty', 'error');

    // Normalise column names â€” support common variations
    // Expected: amount, type (expense/income), category, notes, date
    const normalise = (row) => {
      const get = (...keys) => {
        for (const k of keys) {
          const match = Object.keys(row).find(r => r.toLowerCase().trim() === k);
          if (match !== undefined && row[match] !== undefined && row[match] !== '') return row[match];
        }
        return null;
      };

      const rawAmount = parseFloat(get('amount', 'amt', 'sum', 'value'));
      if (isNaN(rawAmount)) return null; // skip rows with no amount

      const rawDate = get('date', 'created_at', 'datetime', 'timestamp', 'time');
      let created_at = new Date().toISOString();
      if (rawDate) {
        // XLSX sometimes gives date as a serial number
        const parsed = typeof rawDate === 'number'
          ? new Date(Math.round((rawDate - 25569) * 86400 * 1000))
          : new Date(rawDate);
        if (!isNaN(parsed)) created_at = parsed.toISOString();
      }

      const rawType = (get('type', 'kind', 'transaction type') || '').toString().toLowerCase();
      const type = rawType.includes('inc') || rawAmount < 0 ? 'income' : 'expense';

      return {
        user_id:    currentUser.id,
        amount:     Math.abs(rawAmount),
        type,
        category:   (get('category', 'cat', 'label', 'tag') || 'Other').toString(),
        notes:      (get('notes', 'note', 'description', 'desc', 'memo') || '').toString(),
        created_at,
      };
    };

    const records = rows.map(normalise).filter(Boolean);
    if (!records.length) return showToast('No valid rows found â€” check column names', 'error');

    // Show progress bar
    const bar = document.getElementById('import-bar');
    const fill = document.getElementById('import-bar-fill');
    const label = document.getElementById('import-bar-label');
    bar.classList.add('show');

    // Insert in batches of 50
    const BATCH = 50;
    let done = 0;
    for (let i = 0; i < records.length; i += BATCH) {
      const batch = records.slice(i, i + BATCH);
      try {
        for (const tx of batch) await api.transactions.create(tx);
      } catch { showToast('Import failed on batch', 'error'); break; }
      done += batch.length;
      const pct = Math.round((done / records.length) * 100);
      fill.style.width = pct + '%';
      label.textContent = `Importingâ€¦ ${done} / ${records.length}`;
    }

    bar.classList.remove('show');
    fill.style.width = '0%';
    showToast(`Imported ${done} transactions`, 'success');
    loadTransactions(true);
    loadStats();
  };

  reader.readAsBinaryString(file);
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportData() {
  showToast('Preparing exportâ€¦', 'success');

  // Fetch ALL transactions for export (ignore current period filter)
  let data;
  try {
    data = await api.transactions.list({ limit: 10000 });
  } catch { return showToast('No data to export', 'error'); }
  if (!data?.length) return showToast('No data to export', 'error');

  const rows = data.map(t => ({
    Date:     new Date(t.created_at).toLocaleDateString(),
    Type:     t.type,
    Category: t.category,
    Amount:   parseFloat(t.amount),
    Notes:    t.notes || '',
  }));

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Transactions');

  // Auto-size columns
  const colWidths = Object.keys(rows[0]).map(key => ({
    wch: Math.max(key.length, ...rows.map(r => String(r[key]).length))
  }));
  ws['!cols'] = colWidths;

  XLSX.writeFile(wb, `ledger-export-${new Date().toISOString().slice(0,10)}.xlsx`);
  showToast(`Exported ${rows.length} transactions`, 'success');
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeEdit();
    document.getElementById('settings-overlay').classList.remove('open');
  }
});

document.getElementById('tx-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') addTransaction();
});

init();
</script>
</body>
</html>
