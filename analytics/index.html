<!DOCTYPE html>
<html lang="en">
<head>
<script>
  (async () => {
    const stored = Object.keys(localStorage).find(k => k.startsWith('sb-') && k.endsWith('-auth-token'));
    if (!stored) window.location.replace('../login/');
  })();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Ledger â€” Analytics</title>
<link rel="icon" type="image/x-icon" href="/ledger/favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="config.js"></script>
<script src="api.js"></script>
<script src="theme.js"></script>
<style>
  :root {
    --bg: #0a0a0f; --surface: #111118; --border: #1e1e2e;
    --accent: #c8f560; --accent-text: #0a0a0f; --accent2: #7c6af7;
    --text: #e8e8f0; --muted: #5a5a7a; --danger: #ff5f6d; --success: #4ade80;
    --grid-line: rgba(200,245,96,0.025);
  }
  [data-theme="light"] {
    --bg: #f5f5f0; --surface: #ffffff; --border: #e0e0d8;
    --accent: #5a8a00; --accent-text: #ffffff; --accent2: #5b4fcf;
    --text: #1a1a24; --muted: #8a8a9a; --danger: #d93025; --success: #1e7e34;
    --grid-line: rgba(90,138,0,0.05);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; min-height: 100vh; transition: background 0.3s, color 0.3s; }

  .grid-bg {
    position: fixed; inset: 0;
    background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none;
  }

    input {
    width: 100%; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 12px 14px; color: var(--text);
    font-family: 'Roboto', sans-serif; font-size: 16px;
    outline: none; transition: border-color 0.2s, background 0.3s;
  }
  input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(200,245,96,0.08);
  }

  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.9); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border); padding: 0 24px; height: 60px;
    display: flex; align-items: center; justify-content: space-between;
    transition: background 0.3s, border-color 0.3s;
  }
  [data-theme="light"] nav { background: rgba(245,245,240,0.92); }

  .nav-brand { font-family: 'Roboto Slab', serif; font-size: 1.4rem; color: var(--accent); text-decoration: none; }
  .nav-links { display: flex; gap: 4px; align-items: center; }

  .nav-link {
    padding: 7px 14px; border-radius: 6px; font-family: 'Roboto', sans-serif;
    font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase;
    cursor: pointer; border: none; background: none; color: var(--muted);
    transition: all 0.2s; text-decoration: none; display: inline-block;
  }
  .nav-link:hover, .nav-link.active { color: var(--text); background: var(--border); }
  .nav-link.logout { color: var(--danger); }
  .nav-link.logout:hover { background: rgba(217,48,37,0.1); }

  .icon-btn {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; width: 34px; height: 34px; font-size: 0.95rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; color: var(--text); flex-shrink: 0;
  }
  .icon-btn:hover { border-color: var(--accent); }

  main { max-width: 900px; margin: 0 auto; padding: 40px 20px 80px; position: relative; z-index: 1; }

  .page-title { font-family: 'Roboto Slab', serif; font-size: 2rem; margin-bottom: 32px; }

  .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 32px; }
  .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: background 0.3s, border-color 0.3s; }
  .summary-label { font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
  .summary-value { font-family: 'Roboto Slab', serif; font-size: 1.8rem; }
  .summary-value.red { color: var(--danger); }
  .summary-value.green { color: var(--success); }

  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; transition: background 0.3s, border-color 0.3s; }
  .chart-card.full { grid-column: 1 / -1; }
  .chart-title { font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 20px; }
  .chart-wrap { position: relative; height: 260px; }
  .chart-wrap.tall { height: 300px; }

  .legend { margin-top: 20px; display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
  .legend::-webkit-scrollbar { width: 4px; }
  .legend::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.75rem; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .legend-name { flex: 1; }
  .legend-amount { color: var(--muted); }
  .legend-pct { color: var(--accent); font-size: 0.65rem; background: rgba(200,245,96,0.1); padding: 2px 6px; border-radius: 4px; }
  [data-theme="light"] .legend-pct { background: rgba(90,138,0,0.1); }

  .empty-analytics { text-align: center; padding: 80px 20px; color: var(--muted); }
  .empty-analytics .big { font-size: 3rem; margin-bottom: 12px; }
  .empty-analytics a { color: var(--accent); text-decoration: none; }

  @media (max-width: 600px) {
    .charts-grid { grid-template-columns: 1fr; }
    .chart-card.full { grid-column: 1; }
    .summary-grid { grid-template-columns: 1fr 1fr; }
    .summary-grid .summary-card:last-child { grid-column: 1 / -1; }
    nav { padding: 0 16px; }
  }
</style>
</head>
<body>
<div class="grid-bg"></div>

<nav>
  <a class="nav-brand" href="../app/">Ledger</a>
  <div class="nav-links">
    <a href="../app/" class="nav-link">Home</a>
    <a href="../analytics/" class="nav-link active">Analytics</a>
    <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle theme">â˜€</button>
    <button class="nav-link logout" onclick="logout()">Logout</button>
  </div>
</nav>

<main>
  <div class="page-title">Analytics <input id="search-input" type="text" placeholder="Enter search query" ></input></div>
  <div id="content"><div class="empty-analytics"><p>Loading data...</p></div></div>
</main>

<script>
let userCurrency = 'USD';

const COLORS = ['#c8f560','#7c6af7','#ff5f6d','#4ade80','#fb923c',
                '#38bdf8','#e879f9','#fbbf24','#34d399','#f87171',
                '#a78bfa','#67e8f9','#86efac','#fca5a5','#fed7aa'];

function fmt(n) {
  return new Intl.NumberFormat(undefined, {
    style: 'currency', currency: userCurrency,
    maximumFractionDigits: userCurrency === 'JPY' || userCurrency === 'KRW' ? 0 : 2
  }).format(n || 0);
}

function fmtMonth(d) {
  return new Date(d).toLocaleDateString(undefined, { month: 'short', year: '2-digit' });
}

function chartDefaults() {
  const light = document.documentElement.getAttribute('data-theme') === 'light';
  return {
    color: light ? '#8a8a9a' : '#5a5a7a',
    gridColor: light ? '#e8e8e0' : '#1e1e2e',
    tooltipBg: light ? '#ffffff' : '#111118',
    tooltipBorder: light ? '#e0e0d8' : '#1e1e2e',
  };
}

async function init() {
  if (!api.auth.isLoggedIn()) return window.location.replace('../login/');
  try {
    const s = await api.settings.get();
    if (s?.currency) userCurrency = s.currency;
  } catch {}
  loadAnalytics();
  const searchInput = document.getElementById('search-input');
  searchInput.addEventListener('blur', (e) => {
    if (searchQ == e.target.value) return;
    loadAnalytics(e.target.value);
    searchQ = e.target.value;
  })
}

let searchQ;

async function loadAnalytics(searchq) {
  let data;
  try { data = await api.transactions.list({ limit: 10000 }); } catch {}
  if (!data?.length) {
    document.getElementById('content').innerHTML = `
      <div class="empty-analytics">
        <div class="big">ðŸ“ˆ</div>
        <p>No data yet. <a href="../app/">Add some transactions</a> to see analytics.</p>
      </div>`;
    return;
  }

  const expenses = data.filter(t => t.type === 'expense');
  const incomes  = data.filter(t => t.type === 'income');
  const totalExpense = expenses.reduce((s, t) => s + parseFloat(t.amount), 0);
  const totalIncome  = incomes.reduce((s, t) => s + parseFloat(t.amount), 0);

  const catMap = {};
  expenses.forEach(t => { catMap[t.category] = (catMap[t.category] || 0) + parseFloat(t.amount); });
  const byCategory = Object.entries(catMap).map(([c, t]) => ({ category: c, total: t })).sort((a, b) => b.total - a.total);

  const monthMap = {};
  const cutoff = new Date(); cutoff.setMonth(cutoff.getMonth() - 5); cutoff.setDate(1);
  data.filter(t => new Date(t.created_at) >= cutoff).forEach(t => {
    const key = fmtMonth(t.created_at);
    if (!monthMap[key]) monthMap[key] = { expense: 0, income: 0 };
    monthMap[key][t.type] += parseFloat(t.amount);
  });
  const months = Object.keys(monthMap);

  renderCharts({ byCategory, months, monthMap, totalExpense, totalIncome });
}

function renderCharts({ byCategory, months, monthMap, totalExpense, totalIncome }) {
  const net = totalIncome - totalExpense;
  const d = chartDefaults();

  document.getElementById('content').innerHTML = `
    <div class="summary-grid">
      <div class="summary-card"><div class="summary-label">Total Expenses</div><div class="summary-value red">${fmt(totalExpense)}</div></div>
      <div class="summary-card"><div class="summary-label">Total Income</div><div class="summary-value green">${fmt(totalIncome)}</div></div>
      <div class="summary-card"><div class="summary-label">Net Balance</div><div class="summary-value ${net >= 0 ? 'green' : 'red'}">${fmt(net)}</div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">Spending by Category</div>
        <div class="chart-wrap"><canvas id="pie-chart"></canvas></div>
        <div class="legend" id="pie-legend"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Top Categories</div>
        <div class="chart-wrap"><canvas id="bar-chart"></canvas></div>
      </div>
      <div class="chart-card full">
        <div class="chart-title">Monthly Trend (Last 6 Months)</div>
        <div class="chart-wrap tall"><canvas id="line-chart"></canvas></div>
      </div>
    </div>
  `;

  Chart.defaults.color = d.color;
  Chart.defaults.font.family = "'Roboto', sans-serif";
  Chart.defaults.font.size = 11;

  const tip = {
    backgroundColor: d.tooltipBg,
    borderColor: d.tooltipBorder,
    borderWidth: 1,
    titleColor: d.color,
    bodyColor: d.color,
    padding: 10,
  };

  // PIE
  const pieData = byCategory.slice(0, 10);
  new Chart(document.getElementById('pie-chart'), {
    type: 'doughnut',
    data: { labels: pieData.map(c => c.category), datasets: [{ data: pieData.map(c => c.total), backgroundColor: COLORS.slice(0, pieData.length), borderWidth: 0, hoverOffset: 8 }] },
    options: { responsive: true, maintainAspectRatio: false, cutout: '68%',
      plugins: { legend: { display: false }, tooltip: { ...tip, callbacks: { label: ctx => ` ${ctx.label}: ${fmt(ctx.raw)} (${((ctx.raw / totalExpense) * 100).toFixed(1)}%)` }}}
    }
  });

  document.getElementById('pie-legend').innerHTML = pieData.map((c, i) => `
    <div class="legend-item">
      <div class="legend-dot" style="background:${COLORS[i]}"></div>
      <div class="legend-name">${c.category}</div>
      <div class="legend-amount">${fmt(c.total)}</div>
      <div class="legend-pct">${((c.total / totalExpense) * 100).toFixed(0)}%</div>
    </div>`).join('');

  // BAR
  const top = byCategory.slice(0, 8);
  new Chart(document.getElementById('bar-chart'), {
    type: 'bar',
    data: { labels: top.map(c => c.category), datasets: [{ data: top.map(c => c.total), backgroundColor: COLORS.slice(0, top.length).map(c => c + 'cc'), borderColor: COLORS.slice(0, top.length), borderWidth: 1, borderRadius: 6 }] },
    options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { ...tip, callbacks: { title: items => items[0].label, label: ctx => ` ${fmt(ctx.raw)}` }}},
      scales: {
        x: { grid: { color: d.gridColor }, ticks: { maxRotation: 35, color: d.color } },
        y: { grid: { color: d.gridColor }, ticks: { callback: v => fmt(v), color: d.color } }
      }
    }
  });

  // LINE
  if (months.length) {
    new Chart(document.getElementById('line-chart'), {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          { label: 'Expenses', data: months.map(m => monthMap[m]?.expense || 0), borderColor: '#ff5f6d', backgroundColor: 'rgba(255,95,109,0.1)', fill: true, tension: 0.4, pointBackgroundColor: '#ff5f6d', pointRadius: 4 },
          { label: 'Income',   data: months.map(m => monthMap[m]?.income  || 0), borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)',  fill: true, tension: 0.4, pointBackgroundColor: '#4ade80', pointRadius: 4 }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { labels: { color: d.color, usePointStyle: true, pointStyleWidth: 8 } },
          tooltip: { ...tip, callbacks: { label: ctx => ` ${ctx.dataset.label}: ${fmt(ctx.raw)}` }}
        },
        scales: {
          x: { grid: { color: d.gridColor }, ticks: { color: d.color } },
          y: { grid: { color: d.gridColor }, ticks: { callback: v => fmt(v), color: d.color } }
        }
      }
    });
  }
}

function logout() { api.auth.logout(); }

init();
</script>
</body>
</html>
